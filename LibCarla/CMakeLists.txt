set(LIBCARLA_SERVER_BUILD_DIR ${SERVER_BUILD_DIR}/libcarla)
set(LIBCARLA_CLIENT_BUILD_DIR ${CLIENT_BUILD_DIR}/libcarla)

configure_file(
    ${CLIENT_TOOLCHAIN_CMAKE_IN} ${CLIENT_TOOLCHAIN_CMAKE}
)
configure_file(
    ${SERVER_TOOLCHAIN_CMAKE_IN} ${SERVER_TOOLCHAIN_CMAKE}
)


if(BUILD_CLIENT)
    # client
    set(CLIEBT_CMAKE_EXTRA_OPTIONS "")
    set(CARLA_BUILD_TYPE "Client")
    set(LIBCARLA_BUILD_DEBUG ${CARLA_BUILD_DEBUG})
    set(LIBCARLA_BUILD_RELEASE ${CARLA_BUILD_RELEASE})
    set(CMAKE_TOOLCHAIN_FILE ${CLIENT_TOOLCHAIN_CMAKE})
    set(INSTALL_PREFIX ${LIBCARLA_CLIENT_INSTALL_DIR})
    set(CMAKE_EXPORT_COMPILE_COMMANDS 1)
    set(LIBCARLA_BUILD_DIR ${LIBCARLA_CLIENT_BUILD_DIR})
else()
    # server
    set(CLIEBT_CMAKE_EXTRA_OPTIONS "")
    set(CARLA_BUILD_TYPE "Server")
    set(LIBCARLA_BUILD_DEBUG ${CARLA_BUILD_DEBUG})
    set(LIBCARLA_BUILD_RELEASE ${CARLA_BUILD_RELEASE})
    set(CMAKE_TOOLCHAIN_FILE ${SERVER_TOOLCHAIN_CMAKE})
    set(INSTALL_PREFIX ${LIBCARLA_SERVER_INSTALL_DIR})
    set(CMAKE_EXPORT_COMPILE_COMMANDS 1)
    set(LIBCARLA_BUILD_DIR ${LIBCARLA_SERVER_BUILD_DIR})
endif(BUILD_CLIENT)

file(MAKE_DIRECTORY ${LIBCARLA_BUILD_DIR})
include(${CMAKE_TOOLCHAIN_FILE})

add_custom_target(
    build_libcarla
    COMMAND ${CMAKE_COMMAND}
        ${CMAKE_CURRENT_LIST_DIR}/cmake
        -G "Eclipse CDT4 - Unix Makefiles"
        -DCLIEBT_CMAKE_EXTRA_OPTIONS=${CLIEBT_CMAKE_EXTRA_OPTIONS}
        -DCARLA_BUILD_TYPE=${CARLA_BUILD_TYPE}
        -DLIBCARLA_BUILD_DEBUG=${LIBCARLA_BUILD_DEBUG}
        -DLIBCARLA_BUILD_RELEASE=${LIBCARLA_BUILD_RELEASE}
        -DCMAKE_TOOLCHAIN_FILE=${CMAKE_TOOLCHAIN_FILE}
        -DCARLA_CONFIG_FILE=${CARLA_CONFIG_CMAKE}
        -DCARLA_THIRD_PARTIES_INFO_FILE=${CARLA_THIRD_PARTIES_INFO_CMAKE}
        -DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX}
        -DCMAKE_EXPORT_COMPILE_COMMANDS=${CMAKE_EXPORT_COMPILE_COMMANDS}
    WORKING_DIRECTORY ${LIBCARLA_BUILD_DIR}
)

add_custom_target(
    install_libcarla
    DEPENDS build_libcarla
    COMMAND make && make install -j ${CARLA_BUILD_CONCURRENCY}
    WORKING_DIRECTORY ${LIBCARLA_BUILD_DIR}
)
